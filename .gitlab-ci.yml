stages:
  - "ðŸ” Lint"
  - "ðŸ§ª Test"
  - "ðŸ“¦ Build"
  - "ðŸ§ª Smoke"
  - "ðŸ³ Docker"
  - "ðŸš€ Deploy"

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  OCI_IMAGE: "$CI_REGISTRY_IMAGE/hyrise"

cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .cache/pip/

"ðŸ” Lint Python":
  stage: "ðŸ” Lint"
  image: python:3.11
  script:
    - python -m pip install --upgrade pip
    - pip install -e ".[dev]"
    - ruff check --select E9,F63,F7,F82 src tests
  allow_failure: false

"ðŸ§ª Python Unit Tests":
  stage: "ðŸ§ª Test"
  image: python:3.11
  needs:
    - "ðŸ” Lint Python"
  script:
    - python -m pip install --upgrade pip
    - pip install -e ".[dev]"
    - python -m pytest tests/ -v --tb=short --cov=hyrise --cov-report=xml --cov-report=term --junitxml=junit.xml
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - coverage.xml
      - junit.xml
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  allow_failure: false

"ðŸ“¦ Build Package":
  stage: "ðŸ“¦ Build"
  image: python:3.11
  script:
    - python -m pip install --upgrade pip build twine
    - rm -rf build dist smoke-out container-assets .docker-smoke-out .apptainer-smoke-out .cache
    - find . -type d -name "*.egg-info" -prune -exec rm -rf {} +
    - find . -type d -name "__pycache__" -prune -exec rm -rf {} +
    - rm -f *.sif
    - python -m build
    - python -m twine check dist/*.whl dist/*.tar.gz
    - |
      if git ls-files | grep -E '(^|/)(build|dist)/|\.egg-info/|\.sif$'; then
        echo "Tracked build artifacts detected. Remove build/, dist/, *.egg-info, *.sif from git history/index."
        exit 1
      fi
    - |
      if git status --porcelain | grep -E ' (build/|dist/|.*\.egg-info/|.*\.sif$)'; then
        echo "Build artifacts are appearing in git status. Ensure .gitignore excludes them."
        exit 1
      fi
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

"ðŸ§ª Installed Wheel Smoke":
  stage: "ðŸ§ª Smoke"
  image: python:3.11
  needs:
    - job: "ðŸ“¦ Build Package"
      artifacts: true
  script:
    - python -m venv .venv-smoke
    - . .venv-smoke/bin/activate
    - python -m pip install --upgrade pip
    - pip install dist/*.whl
    - hyrise --help > /dev/null
    - python -m hyrise --help > /dev/null
    - python -c "import hyrise; print(hyrise.__version__)"
    - python -c "from hyrise import *; print(__version__)"
    - hyrise --version
    - hyrise container --help > /dev/null
    - rm -rf container-assets && mkdir -p container-assets
    - hyrise container --extract-def container-assets
    - hyrise container --extract-dockerfile container-assets
    - test -f container-assets/hyrise.def
    - test -f container-assets/Dockerfile
    - rm -rf smoke-out && mkdir -p smoke-out
    - hyrise process -i example_data/public/DEMO_IN_NGS_results.json --out smoke-out
    - test -n "$(ls smoke-out/*_mqc.json 2>/dev/null)"
    - test -n "$(ls smoke-out/*_mqc.html 2>/dev/null)"
  artifacts:
    when: always
    paths:
      - container-assets/
      - smoke-out/
    expire_in: 1 week

"ðŸ³ Docker Build And Run Smoke":
  stage: "ðŸ³ Docker"
  image: docker:20.10.12
  services:
    - name: docker:20.10.12-dind
      command: ["--tls=true"]
  variables:
    DOCKER_HOST: "tcp://docker:2376"
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: "1"
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  script:
    - |
      if ! docker info > /dev/null 2>&1; then
        echo "Docker daemon unavailable on this runner; skipping docker smoke job."
        exit 0
      fi
    - IMAGE_TAG="$OCI_IMAGE:$CI_COMMIT_SHA"
    - docker build -f src/hyrise/Dockerfile -t "$IMAGE_TAG" .
    - rm -rf .docker-smoke-out && mkdir -p .docker-smoke-out && chmod 0777 .docker-smoke-out
    - docker run --rm --user "$(id -u):$(id -g)" -v "$CI_PROJECT_DIR:/data" "$IMAGE_TAG" --help > /dev/null
    - docker run --rm --user "$(id -u):$(id -g)" -v "$CI_PROJECT_DIR:/data" "$IMAGE_TAG" process -i /data/example_data/public/DEMO_IN_NGS_results.json --out /data/.docker-smoke-out
    - test -n "$(ls .docker-smoke-out/*_mqc.json 2>/dev/null)"
    - test -n "$(ls .docker-smoke-out/*_mqc.html 2>/dev/null)"
  rules:
    - if: '$GITLAB_CI == "false"'
      when: never
    - when: on_success
  artifacts:
    when: always
    paths:
      - .docker-smoke-out/
    expire_in: 1 week

"ðŸš€ Deploy PyPI Dev":
  stage: "ðŸš€ Deploy"
  image: python:3.11
  needs:
    - job: "ðŸ“¦ Build Package"
      artifacts: true
  script:
    - pip install twine
    - echo "Deploying development version to PyPI"
    - test -n "$PYPI_USERNAME" && test -n "$PYPI_API_TOKEN"
    - twine upload dist/* -u ${PYPI_USERNAME} -p ${PYPI_API_TOKEN} --skip-existing
  rules:
    - if: '$CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH && $CI_COMMIT_BRANCH'
      when: manual
    - when: never

"ðŸš€ Deploy PyPI Production":
  stage: "ðŸš€ Deploy"
  image: python:3.11
  needs:
    - job: "ðŸ“¦ Build Package"
      artifacts: true
  script:
    - pip install twine
    - echo "Deploying production version to PyPI"
    - test -n "$PYPI_USERNAME" && test -n "$PYPI_API_TOKEN"
    - twine upload dist/* -u ${PYPI_USERNAME} -p ${PYPI_API_TOKEN} --skip-existing
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+.*$/'
      when: manual
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: manual
    - when: never

"ðŸ³ Deploy Container":
  stage: "ðŸš€ Deploy"
  image: docker:20.10.12
  services:
    - name: docker:20.10.12-dind
      command: ["--tls=true"]
  variables:
    DOCKER_HOST: "tcp://docker:2376"
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: "1"
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  script:
    - |
      if ! docker info > /dev/null 2>&1; then
        echo "Docker daemon unavailable on this runner; skipping container publish."
        exit 0
      fi
    - test -n "$CI_REGISTRY" && test -n "$CI_REGISTRY_USER" && test -n "$CI_REGISTRY_PASSWORD"
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - IMAGE_SHA="$OCI_IMAGE:$CI_COMMIT_SHA"
    - docker build -f src/hyrise/Dockerfile -t "$IMAGE_SHA" .
    - docker push "$IMAGE_SHA"
    - |
      if [ "$CI_COMMIT_BRANCH" = "$CI_DEFAULT_BRANCH" ]; then
        docker tag "$IMAGE_SHA" "$OCI_IMAGE:latest"
        docker push "$OCI_IMAGE:latest"
      fi
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        docker tag "$IMAGE_SHA" "$OCI_IMAGE:$CI_COMMIT_TAG"
        docker push "$OCI_IMAGE:$CI_COMMIT_TAG"
      fi
  rules:
    - if: '$GITLAB_CI == "false"'
      when: never
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: manual
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+.*$/'
      when: manual
    - when: never

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'
    - if: '$CI_COMMIT_TAG'
